# ノウハウ記録: Build 7 審査再提出（2026-02-20）

## 概要
Build 6 が Guideline 2.1（iPad Air 11-inch M3 でクラッシュ）でリジェクトされ、修正後 Build 7 を再提出するまでの全工程を Cowork で自動化した。

---

## 1. iPad起動クラッシュの修正

### 原因
- Firebase初期化が重複するケースでクラッシュ
- TARGETED_DEVICE_FAMILY が "1"（iPhoneのみ）だったがiPadでもテストされた

### 修正内容（Codexコミット d9c35e8）
```dart
// Firebase初期化ガード
if (Firebase.apps.isEmpty) {
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);
}
// duplicate-app例外ハンドリング
try { ... } on FirebaseException catch (e) {
  if (e.code != 'duplicate-app') rethrow;
}
// 全サービス初期化をtry/catchで囲む
// runZonedGuardedでアプリ全体をラップ
```

### project.pbxproj
```
TARGETED_DEVICE_FAMILY = "1,2";  // iPhone + iPad
```

---

## 2. iPadマルチタスキング要件

### 問題
TARGETED_DEVICE_FAMILY を "1,2" にすると、iPad向けの要件が追加される:
- **全4方向のインターフェース回転をサポート**必須
- `UIInterfaceOrientationPortraitUpsideDown` が欠けていた

### 修正
Info.plist の `UISupportedInterfaceOrientations` に以下を追加:
```xml
<string>UIInterfaceOrientationPortraitUpsideDown</string>
```

### 教訓
- TARGETED_DEVICE_FAMILY を "1,2" にする場合は必ず全4方向を設定する
- xcrun altool のバリデーションで検出される（アップロード時エラー）

---

## 3. ビルド・署名・アップロードパイプライン

### 手順
```
flutter build ios --release
    ↓
xcodebuild -workspace ... -scheme Runner archive -archivePath build/Runner.xcarchive
    ↓
xcodebuild -exportArchive -archivePath build/Runner.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath build/ipa
    ↓
xcrun altool --upload-app --type ios -f "build/ipa/三賢会議.ipa" --apiKey P26V6QTLTW --apiIssuer e359cd97-...
```

### ExportOptions.plist
```xml
<dict>
  <key>method</key><string>app-store-connect</string>
  <key>teamID</key><string>5CMYP437MX</string>
  <key>uploadBitcode</key><false/>
  <key>uploadSymbols</key><true/>
  <key>signingStyle</key><string>automatic</string>
  <key>destination</key><string>export</string>  ← "upload"だとAPIキー不在で失敗
</dict>
```

### 重要: destination: export vs upload
- `export`: IPAファイルをローカルに出力するだけ。アップロードは別途altoolで行う
- `upload`: Xcodebuildが直接App Store Connectにアップロードしようとする。APIキーのパスを環境変数で設定する必要があり、中継サーバー経由だと難しい

### IPA ファイル名
- アプリ表示名が日本語の場合、IPA名も日本語になる（例: `三賢会議.ipa`）
- `Runner.ipa` ではないので注意

---

## 4. App Store Connect API 認証

### JWT トークン生成
```python
import jwt, time

payload = {
    "iss": ISSUER_ID,
    "iat": int(time.time()),
    "exp": int(time.time()) + 1200,
    "aud": "appstoreconnect-v1"
}
headers = {"alg": "ES256", "kid": API_KEY_ID, "typ": "JWT"}
token = jwt.encode(payload, private_key, algorithm="ES256", headers=headers)
```

### 必要なライブラリ
```bash
pip install PyJWT cryptography requests
```

### 認証情報の保管
- `.appstoreconnect/private_keys/AuthKey_P26V6QTLTW.p8` にプロジェクト内保存
- `.gitignore` に `.appstoreconnect/` を追加

---

## 5. スクリーンショットAPI アップロード（最重要ノウハウ）

### 背景
- ブラウザUIの `<input type="file">` はmacOSネイティブダイアログを開くため、Cowork VMからは操作不可
- App Store Connect API で直接アップロードすることで完全自動化が可能

### フロー
```
1. GET /v1/apps/{appId}/appStoreVersions → version_id
2. GET /v1/appStoreVersions/{versionId}/appStoreVersionLocalizations → localization_id
3. GET /v1/appStoreVersionLocalizations/{locId}/appScreenshotSets → 既存セット確認
4. POST /v1/appScreenshotSets → iPad用セット作成（display type指定）
5. POST /v1/appScreenshots → 各画像のアップロード枠予約
6. PUT（uploadOperations のURL）→ 実際のファイルデータアップロード
7. PATCH /v1/appScreenshots/{id} → アップロード完了をコミット
```

### ディスプレイタイプ一覧（よく使うもの）
| デバイス | screenshotDisplayType |
|---|---|
| iPhone 6.5" | APP_IPHONE_65 |
| iPhone 6.7" | APP_IPHONE_67 |
| iPad Pro 12.9" (3rd gen) / 13" | APP_IPAD_PRO_3GEN_129 |

### 画像サイズ要件（iPad 13"）
- 2064 × 2752px（ポートレート）
- 2752 × 2064px（ランドスケープ）
- 2048 × 2732px（ポートレート、旧サイズ）
- 2732 × 2048px（ランドスケープ、旧サイズ）

---

## 6. 暗号化コンプライアンス

### ブラウザ操作の問題
- App Store Connectの暗号化コンプライアンスダイアログの「保存」ボタンがアクセシビリティツリーに表示されないことがある
- `find` ツールでは見つからないが、JavaScript の `document.querySelectorAll('button')` でテキスト検索すると見つかる
- ダイアログが閉じない場合は名前なしリンク（ref_XXX）が保存ボタンの場合がある

### APIでの設定方法（未検証だが推奨）
- `PATCH /v1/builds/{buildId}` で `usesNonExemptEncryption: false` を設定可能
- これによりブラウザ操作が不要になる

---

## 7. 中継サーバー（cowork-codex-relay）の制約

### できること
- flutter analyze/test/build
- xcode archive/export/upload
- プロジェクト切り替え

### できないこと
- 任意のシェルコマンド実行
- git push
- fastlane実行
- ファイル読み書き

### ngrok タイムアウト
- `xcode_archive` 等の長時間コマンドは ngrok の Gateway Timeout (ERR_NGROK_3004) でエラーになる
- 非同期実行（`"async": true`）は relay server のジョブキューが不安定
- **対策**: Mac側で直接ターミナルから実行

### 改善提案
- relay server に `git_push` コマンドを追加
- relay server に `fastlane_deliver` コマンドを追加
- relay server にファイル読み取りAPI（`/api/read-file`）を追加

---

## 8. App Store Connect ブラウザ操作のTips

### 審査再提出フロー
1. バージョンページで「審査内容を更新」ボタンをクリック
2. 提出詳細ページで「App Reviewに再提出」をクリック
3. ステータスが「審査待ち」に変更されることを確認

### ビルドのコンプライアンス
- Build一覧で「コンプライアンスがありません 管理」が表示される場合は「管理」をクリック
- ラジオボタンで暗号化タイプを選択 → 保存

---

## 9. 今後の完全自動化ロードマップ

### Phase 1（現在到達点）
- [x] flutter build → xcode archive → IPA export → altool upload（Mac中継サーバー経由）
- [x] スクリーンショットAPI アップロード（Cowork VM直接）
- [x] 暗号化コンプライアンス設定（ブラウザ操作）
- [x] 審査提出（ブラウザ操作）

### Phase 2（次の目標）
- [ ] relay server に git push コマンド追加
- [ ] relay server に fastlane コマンド追加
- [ ] 暗号化コンプライアンスをAPI経由に移行
- [ ] 審査提出をAPI経由に移行
- [ ] 全工程を1コマンドで実行するスクリプト化

### Phase 3（最終目標）
- [ ] Cowork scheduled task で定期監視（審査結果チェック）
- [ ] リジェクト時の自動修正フロー
- [ ] 新アプリの初期設定完全自動化
